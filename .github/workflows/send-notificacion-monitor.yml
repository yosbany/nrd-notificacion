name: Enviar Notificación FCM (API V1)

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Título de la notificación'
        required: true
        default: 'Notificación desde GitHub Actions'
      message:
        description: 'Mensaje de la notificación'
        required: true
        default: 'Esta es una notificación de prueba'

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar dependencias Python
        run: |
          pip install pyjwt requests cryptography

      - name: Guardar Service Account JSON
        run: |
          echo '${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}' > service-account.json

      - name: Obtener token OAuth2
        id: get-token
        run: |
          python3 << 'EOF'
          import json
          import time
          import jwt
          import requests
          import sys
          import os
          
          # Leer Service Account JSON
          with open('service-account.json', 'r') as f:
              service_account = json.load(f)
          
          # Crear JWT
          now = int(time.time())
          payload = {
              'iss': service_account['client_email'],
              'sub': service_account['client_email'],
              'aud': 'https://oauth2.googleapis.com/token',
              'iat': now,
              'exp': now + 3600,
              'scope': 'https://www.googleapis.com/auth/firebase.messaging'
          }
          
          # Firmar JWT
          jwt_token = jwt.encode(payload, service_account['private_key'], algorithm='RS256')
          
          # Intercambiar JWT por access token
          response = requests.post('https://oauth2.googleapis.com/token', data={
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': jwt_token
          })
          
          if response.status_code == 200:
              access_token = response.json()['access_token']
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"ACCESS_TOKEN={access_token}\n")
          else:
              print(f"Error: {response.text}", file=sys.stderr)
              sys.exit(1)
          EOF
          echo "Token obtenido exitosamente"

      - name: Enviar notificación FCM
        run: |
          curl -X POST "https://fcm.googleapis.com/v1/projects/${{ secrets.FCM_PROJECT_ID }}/messages:send" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ env.ACCESS_TOKEN }}" \
            -d '{
              "message": {
                "token": "${{ secrets.FCM_DEVICE_TOKEN }}",
                "notification": {
                  "title": "${{ github.event.inputs.title }}",
                  "body": "${{ github.event.inputs.message }}"
                },
                "data": {
                  "title": "${{ github.event.inputs.title }}",
                  "message": "${{ github.event.inputs.message }}"
                }
              }
            }'
