name: NRD Monitor FCM (Programado)

on:
  push:
    branches: [main]
  schedule:
    # Ejecutar cada 5 minutos (UTC)
    # Formato: minuto hora dÃ­a mes dÃ­a-semana
    # */5 * * * * = cada 5 minutos (0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55)
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # Permitir ejecuciÃ³n manual

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: InformaciÃ³n del workflow
        run: |
          echo "========================================="
          echo "ðŸ” InformaciÃ³n del Workflow"
          echo "========================================="
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Timestamp UTC: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "========================================="
          echo ""
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "âœ… Esta ejecuciÃ³n fue activada por SCHEDULE (cron)"
            echo "ðŸ“… Se ejecuta automÃ¡ticamente cada 5 minutos (UTC)"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸ–ï¸  Esta ejecuciÃ³n fue activada MANUALMENTE (workflow_dispatch)"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "ðŸ“¤ Esta ejecuciÃ³n fue activada por PUSH"
          else
            echo "âš ï¸  Evento desconocido: ${{ github.event_name }}"
          fi
          echo ""
          
      - name: Verificar variables de entorno
        run: |
          echo "Verificando secrets..."
          if [ -z "${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "âš ï¸ FCM_SERVICE_ACCOUNT_JSON no estÃ¡ configurado"
          else
            echo "âœ… FCM_SERVICE_ACCOUNT_JSON estÃ¡ configurado"
          fi
          if [ -z "${{ secrets.FCM_PROJECT_ID }}" ]; then
            echo "âš ï¸ FCM_PROJECT_ID no estÃ¡ configurado"
          else
            echo "âœ… FCM_PROJECT_ID estÃ¡ configurado"
          fi
          if [ -z "${{ secrets.FCM_DEVICE_TOKEN }}" ]; then
            echo "âš ï¸ FCM_DEVICE_TOKEN no estÃ¡ configurado"
          else
            echo "âœ… FCM_DEVICE_TOKEN estÃ¡ configurado"
          fi

      - name: Instalar dependencias Python
        run: |
          pip install pyjwt requests cryptography

      - name: Guardar Service Account JSON
        run: |
          echo '${{ secrets.FCM_SERVICE_ACCOUNT_JSON }}' > service-account.json

      - name: Obtener token OAuth2
        id: get-token
        run: |
          python3 << 'EOF'
          import json
          import time
          import jwt
          import requests
          import sys
          import os
          
          # Leer Service Account JSON
          with open('service-account.json', 'r') as f:
              service_account = json.load(f)
          
          # Crear JWT
          now = int(time.time())
          payload = {
              'iss': service_account['client_email'],
              'sub': service_account['client_email'],
              'aud': 'https://oauth2.googleapis.com/token',
              'iat': now,
              'exp': now + 3600,
              'scope': 'https://www.googleapis.com/auth/firebase.messaging'
          }
          
          # Firmar JWT
          jwt_token = jwt.encode(payload, service_account['private_key'], algorithm='RS256')
          
          # Intercambiar JWT por access token
          response = requests.post('https://oauth2.googleapis.com/token', data={
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': jwt_token
          })
          
          if response.status_code == 200:
              access_token = response.json()['access_token']
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"ACCESS_TOKEN={access_token}\n")
          else:
              print(f"Error: {response.text}", file=sys.stderr)
              sys.exit(1)
          EOF
          echo "Token obtenido exitosamente"

      - name: Enviar notificaciÃ³n FCM
        run: |
          curl -X POST "https://fcm.googleapis.com/v1/projects/${{ secrets.FCM_PROJECT_ID }}/messages:send" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ env.ACCESS_TOKEN }}" \
            -d '{
              "message": {
                "token": "${{ secrets.FCM_DEVICE_TOKEN }}",
                "notification": {
                  "title": "NRD Monitor",
                  "body": "Monitor ejecutado - Run #${{ github.run_number }}"
                },
                "data": {
                  "title": "NRD Monitor",
                  "message": "Monitor ejecutado - Run #${{ github.run_number }}",
                  "run_id": "${{ github.run_id }}",
                  "run_number": "${{ github.run_number }}",
                  "workflow": "${{ github.workflow }}",
                  "event": "${{ github.event_name }}"
                }
              }
            }'
